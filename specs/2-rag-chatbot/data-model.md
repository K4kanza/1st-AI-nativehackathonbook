# Data Model: Integrated RAG Chatbot for Book

## Core Entities

### BookContent
- **Attributes**:
  - id: unique identifier for the book content
  - title: title of the book
  - version: version identifier (git SHA or semantic version)
  - source_path: path to the original source file (Markdown/MDX)
  - created_at: timestamp when content was ingested
  - updated_at: timestamp when content was last updated
- **Relationships**:
  - Contains multiple Chunks
  - Associated with multiple IngestionRuns

### Chunk
- **Attributes**:
  - id: deterministic chunk ID (v{version}:ch{chapter_idx}:sec{section_idx}:p{para_idx})
  - content: the text content of the chunk
  - embedding: vector embedding of the chunk content
  - chapter_id: identifier for the chapter containing this chunk
  - section_anchor: anchor identifier for the section containing this chunk
  - source_path: reference to the original source file
  - text_hash: hash of the content for change detection
  - book_version_id: reference to the book version
  - position: ordering within the parent section
- **Relationships**:
  - Belongs to one BookContent
  - Associated with multiple QueryLogs (through retrieved chunks)

### Session
- **Attributes**:
  - id: unique session identifier
  - created_at: timestamp when session was created
  - last_seen_at: timestamp of last activity
  - user_agent: client information
  - metadata: additional session-specific data (optional)
- **Relationships**:
  - Contains multiple QueryLogs
  - Belongs to one User (optional, for authenticated users)

### QueryLog
- **Attributes**:
  - id: unique identifier for the query
  - session_id: reference to the user session
  - question: the original user question
  - mode: query mode (BOOK or SELECTED_TEXT)
  - page_context: context of the page where query was made (page_url, chapter_id, section_anchor)
  - selected_text: optional text that was highlighted by the user
  - answer: the answer generated by the system
  - citations: list of chunk IDs used in the response
  - latency_ms: time taken to process the query
  - created_at: timestamp when query was made
- **Relationships**:
  - Belongs to one Session
  - References multiple Chunks (through citations)

### IngestionRun
- **Attributes**:
  - id: unique identifier for the ingestion run
  - book_version_id: reference to the book version being ingested
  - status: status of the ingestion (PENDING, PROCESSING, COMPLETED, FAILED)
  - metrics_json: JSON containing ingestion metrics (counts, failures, etc.)
  - started_at: timestamp when ingestion started
  - finished_at: timestamp when ingestion completed
- **Relationships**:
  - Associated with one BookContent
  - Created multiple Chunks

## Validation Rules

### BookContent Validation
- Version must be unique for each ingestion
- Source path must exist and be accessible
- Content must be in a supported format (Markdown/MDX)

### Chunk Validation
- Chunk ID must follow the deterministic format: v{version}:ch{chapter_idx}:sec{section_idx}:p{para_idx}
- Content must be between 300-800 tokens
- Embedding must be generated successfully
- Text hash must be computed for change detection
- Chapter and section references must be valid

### QueryLog Validation
- Question must be non-empty
- Mode must be either BOOK or SELECTED_TEXT
- If mode is SELECTED_TEXT, selected_text must be non-empty
- Answer must include citations when content is found
- Citations must reference valid chunk IDs

### Session Validation
- Session ID must be unique
- User agent must be properly formatted
- Session must be cleaned up after inactivity period

## State Transitions

### IngestionRun States
- PENDING → PROCESSING → COMPLETED (successful ingestion)
- PENDING → PROCESSING → FAILED (error during ingestion)
- FAILED → PENDING (retry initiated)

### QueryLog States
- New query received → Processing → Response generated
- If no relevant content found → Response indicates "Not found in book"

## Relationships and Constraints

### BookContent to Chunk
- One-to-many relationship
- When BookContent is deleted, associated Chunks should be marked for cleanup
- Chunks are immutable after creation

### Session to QueryLog
- One-to-many relationship
- QueryLogs are retained for analytics even after session expires
- Sessions may be anonymized after retention period

### QueryLog to Chunk
- Many-to-many relationship through citations
- Citations form the basis for answer attribution
- Chunk references in citations must remain valid